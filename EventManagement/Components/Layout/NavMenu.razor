@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using EventManagement.Security
@inject NavigationManager Nav

<nav class="sidebar p-3">
    <div class="brand fw-bold mb-3">EventManagement</div>

    <div class="text-uppercase text-muted small mb-2">Administration</div>

    <!-- Mostra se l'utente ha il permesso: events.manage -->
    <AuthorizeView Policy="@Permissions.Names.ManageEvents">
        <Authorized>
            <NavLink href="/admin/events" Match="NavLinkMatch.All" class="nav-link rounded mb-1">
                <span class="oi oi-cog me-2"></span>Manage Events
            </NavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Mostra se l'utente ha il permesso: permissions.configure (es. Supervisor) -->
    <AuthorizeView Policy="@Permissions.Names.PermissionsConfigure">
        <Authorized>
            <NavLink href="/admin/rolepermissions" class="nav-link rounded mb-1">
                <span class="oi oi-shield me-2"></span>Role Permissions
            </NavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Mostra se l'utente ha il permesso: users.manage (es. Supervisor) -->
    <AuthorizeView Policy="@Permissions.Names.ManageUsers">
        <Authorized>
            <NavLink href="/admin/users" class="nav-link rounded mb-1">
                <span class="oi oi-people me-2"></span>User Management
            </NavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Utente autenticato ma senza permessi "admin": menu standard -->
    <AuthorizeView Context="auth">
        <Authorized>
            @if (!auth.User.HasClaim(Permissions.ClaimType, Permissions.Names.ManageEvents) &&
                        !auth.User.HasClaim(Permissions.ClaimType, Permissions.Names.PermissionsConfigure) &&
                        !auth.User.HasClaim(Permissions.ClaimType, Permissions.Names.ManageUsers))
            {
                <NavLink href="/" Match="NavLinkMatch.All" class="nav-link rounded mb-1">
                    <span class="oi oi-home me-2"></span>Home
                </NavLink>

                <NavLink href="/me/subscriptions" class="nav-link rounded mb-1">
                    <span class="oi oi-list me-2"></span>My Dashboard
                </NavLink>
            }
        </Authorized>

        <!-- Anonimo -->
        <NotAuthorized>
            <NavLink href="/" Match="NavLinkMatch.All" class="nav-link rounded mb-1">
                <span class="oi oi-home me-2"></span>Home
            </NavLink>
        </NotAuthorized>
    </AuthorizeView>

    <!-- Saluto + Logout/Login -->
    <div class="mt-3">
        <AuthorizeView Context="auth">
            <Authorized>
                @{
                    var u = auth.User;

                    // etichetta ruolo "nota" se esiste; altrimenti fallback su nome/email
                    
                    string roleLabel = u.IsInRole("Supervisor") ? "Supervisor" :
                    u.IsInRole("Admin") ? "Admin" : string.Empty;

                    string display =
                    roleLabel
                    ?? (u.FindFirst("name")?.Value
                    ?? u.FindFirst(ClaimTypes.GivenName)?.Value
                    ?? u.FindFirst(ClaimTypes.Name)?.Value
                    ?? u.FindFirst(ClaimTypes.Email)?.Value
                    ?? u.Identity?.Name
                    ?? "User");

                    if (display.Contains("@"))
                        display = display[..display.IndexOf('@')];
                }

                <div class="small text-muted px-1 mb-2">Hello, <b>@display</b></div>

                <form method="post" action="/app-logout" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-light w-100">Logout</button>
                </form>
            </Authorized>

            <NotAuthorized>
                <NavLink href="/account/login" class="nav-link rounded">Login</NavLink>
                <NavLink href="/account/register" class="nav-link rounded">Register</NavLink>
            </NotAuthorized>
        </AuthorizeView>
    </div>
  
</nav>

@code { }
